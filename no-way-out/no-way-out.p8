pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- no-way-out
-- by alexh95

function makeb(x,y,t)
 return {x=x,y=y,t=t}
end

function _init()
 p={x=1,y=1,d=0,sp=4,grab=false}
 c={x=60,y=16}
 b={makeb(0,0,1),
    {x=4,y=4,t=2},
    {x=7,y=7,t=1},
    {x=6,y=7,t=1},
    {x=7,y=6,t=1}}
 lvl={x=8,y=8}
end

function _update60()
 nd=p.d
 dp={x=0,y=0}
 np={x=p.x,y=p.y}
 if btn(🅾️) then
  p.grab=true
 else
  p.grab=false
 end
 if btn(❎) then
  
 end
 if btnp(⬆️) then
  dp.y-=1
  nd=1
 end
 if btnp(⬇️) then
  dp.y+=1
  nd=3
 end
 if btnp(⬅️) then
  dp.x-=1
  nd=2
 end
 if btnp(➡️) then
  dp.x+=1
  nd=0
 end
 np.x+=dp.x
 np.y+=dp.y
 
 if p.grab then
  gp={x=p.x,y=p.y}
  if p.d==0 then gp.x+=1
  elseif p.d==1 then gp.y-=1
  elseif p.d==2 then gp.x-=1
  elseif p.d==3 then gp.y+=1 end
  p.gb=findb(gp)
 else
  p.d=nd
  p.gb=nil
 end
 
 if validp(np) then
  --p.x=np.x
  --p.y=np.y
  if p.gb!=nil then
   ngbp={x=p.gb.x+dp.x,
         y=p.gb.y+dp.y}
   if validp(ngbp) then
    p.x=np.x
    p.y=np.y
    p.gb.x+=dp.x
    p.gb.y+=dp.y
   end
  else
   p.x=np.x
   p.y=np.y
  end
 end
 
end

function validp(np)
 if not inbounds(np,lvl) then
  return false
 end
 if not noblock(np) then
  return false
 end
 return true
end

function findb(bp)
 for bl in all(b) do
  if bl.x==bp.x and bl.y==bp.y then
   return bl
  end
 end
 return nil
end

function noblock(np)
 for bl in all(b) do
  if p.gb!=bl and
     bl.x==np.x and 
     bl.y==np.y then
   return false
  end
 end
 return true
end

function pos(px,py,tx,ty)
 r={}
 r.x=px+tx*4-ty*4
 r.y=py+tx*4+ty*4
 return r
end

function posb(px,py,tx,ty)
 return pos(px,py,tx-1,ty-1)
end

function draw_grid()
 for i=0,lvl.x-1 do
  for j=0,lvl.y-1 do
   sp=pos(c.x,c.y,i,j)
   spr(33,sp.x,sp.y)
  end
 end
end

function draw_player()
 pp=posb(c.x,c.y,p.x,p.y)
 if p.d==0 then
  psp=36
 elseif p.d==1 then
  psp=4
 elseif p.d==2 then
  psp=5
 elseif p.d==3 then
  psp=37
 end
 if p.grab then
  psp+=2
 end
 spr(psp,pp.x,pp.y,1,2)
end

function draw_level()
 bo={}
 for bl in all(b) do
  index=bl.x+bl.y
  if bo[index]==nil then
   bo[index]={}
  end
  add(bo[index],bl)
 end

 for i=0,lvl.x+lvl.y do
  bol=bo[i]
  if bol!=nil then
   --print(i,7)
   for bl_i,bl in pairs(bol) do
    --print(bl,9)
    bp=posb(c.x,c.y,bl.x,bl.y)
    bsp=16
    if bl.t==1 then bsp=14
    elseif bl.t==2 then bsp=15 end
    spr(bsp,bp.x,bp.y,1,2)
   end
  end
  if i==p.x+p.y then
   draw_player()
  end
 end
 
end

function _draw()
 cls()
 rect(0,0,127,127,1)
 print('no-way-out demo', 7)
 draw_grid()
 draw_level()
end
-->8
-- util
--

function inbounds(a,b)
 return a.x>=0 and a.x<b.x and
        a.y>=0 and a.y<b.y
end

function sorti(t)
 print(t[0],11)
 for n=2,#t do
  i=n
  while i>1 do
   t[i],t[i-1]=t[i-1],t[i]
   i-=1
  end
 end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000ff000000ff000000ff000000ff0000000000000000000000000000000000000000000000000000005500000055000
0070070000000000000000000000000000ffff0000ffff0000ffff0000ffff000000000000000000000000000000000000000000000000000056650000544500
00000000000550000005500000000000033ff000000ff330033ff000000ff3300000000000000000000000000000000000000000000000000566665005444450
000000000058850000588500000000000b333330033333b000333330033333000000000000000000000000000000000000000000000000005666666554444445
000000000588885005888850000ff0000b333330033333b00033333ff33333000000000000000005500000000000000000000005500000005566665555444455
00000000588888855888888500ffff000f3333b00b3333f000333300003333000000000000000058850000000000000000000058850000005656656554544545
00000000558888555588885500ffff0000b333b00b333b0000b3330000333b000000000000000588885000000000000000000588885000005665566554455445
000000005858858558588585033ff00000b3b3f00f3b3b0000b3b300003b3b000000000000005888888500000000000000005888888500005666566554445445
000550005885588558855885033333300066b300003b66000066b300003b66000000000000058888888850000000000000055888888550005666566554445445
0058850005885850058858500b333330000066000066000000006600006600000000000000558888888855000000000000588588885885000566565005445450
0588885000585500005855000b3333b0000000000000000000000000000000000000000000585888888585000000000005888858858888500056550000545500
5888888500055000000550000b3333b0000000000000000000000000000000000000000000588588885885000000000058888885588888850005500000055000
5588885500055000000050000bb333b0000000000000000000000000000000000000000000588858858885000000000055888855558888550000000000000000
58588585005005000005050000b3b3b0000000000000000000000000000000000000000000588885588885000000000058588585585885850000000000000000
58855885050000500050005000b3b300000000000000000000000000000000000000000000588888588885000000000058855885588558850000000000000000
58885885500000050500000500b3b300000000000000000000000000000000000000000000058888588850000000000058885885588858850000000000000000
5888588550000005500000500066b300000ff000000ff000000ff000000ff0000000000000005888588500000000000058885885588858850005500000055000
0588585005000050050005000000660000ffff0000ffff0000ffff0000ffff000000000000000588585000000000000005885850058858500058850000588500
00585500005005000050500000000000000ff330033ff000000ff330033ff0000000000000000058550000000000000000585500005855000588885005888850
00055000000550000005000000000000033339300393333003333930039333300000000000000005500000000000000000055000000550005888888558888885
00000000000000000000000000000000033393300339333003339330033933300000000000000000000000000000000000000000000000005588885555888855
00000000000000000000000000000000033933f00f3393300b33333ff33333b00000000000000000000000000000000000000000000000005858858558588585
00000000000000000000000000000000039333000033393000bf33000033fb000000000000000000000000000000000000000000000000005885588558855885
000000000000000000000000000000000f333300003333f000333300003333000000000000000000000000000000000000000000000000005888588558885885
00000000000000000000000000000000003366000066330000336600006633000000000000000000000000000000000000000000000000005888588558885885
00000000000000000000000000000000006600000000660000660000000066000000000000000000000000000000000000000000000000000588585005885850
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058550000585500
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005500000055000
__label__
77111771111171717771717111111771717177711111771177717771177111111111111111111111111111111111111111111111111111111111111111111111
70707070000070707070707000007070707007000000707070007770707000000000000000000000000000000000000000000000000000000000000000000001
70707070777070707770777077707070707007000000707077007070707000000000000000000000000000000000000000000000000000000000000000000001
70707070000077707070007000007070707007000000707070007070707000000000000000000000000000000000000000000000000000000000000000000001
70707700000077707070777000007700077007000000777077707070770000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000588500000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000005888850000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000058888885000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000055888855000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000058588585000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000058855885000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000058885885000000000000000000000000000000000000000000000000000000000001
100000000000000000000000000000000000000000000000000000000005588ff885500000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000005005ffff50050000000000000000000000000000000000000000000000000000000001
100000000000000000000000000000000000000000000000000000000500005ff330005000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000500003333930000500000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000005500003339330000550000000000000000000000000000000000000000000000000000001
100000000000000000000000000000000000000000000000000000500500033933f0005005000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000500005003933350050000500000000000000000000000000000000000000000000000000001
1000000000000000000000000000000000000000000000000000500000055f333305500000050000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000055000000550336605500000055000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000500500005005660050050000500500000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000005000050050000500500005005000050000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000050000005500000055000000550000005000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000550000005500000055000000550000005500000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000005005000050050000500500005005000050050000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000050000500500005005000050050000500500005000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000500000055000000550000005500000055000000500000000000000000000000000000000000000000001
10000000000000000000000000000000000000000005500000055000000550000005500000055000000550000000000000000000000000000000000000000001
10000000000000000000000000000000000000000050050000500500005005000050050000500500005005000000000000000000000000000000000000000001
10000000000000000000000000000000000000000500005005000050050000500500005005000050050000500000000000000000000000000000000000000001
10000000000000000000000000000000000000005000000550000005500000055000000550000005500000050000000000000000000000000000000000000001
10000000000000000000000000000000000000055000000550000005500000055000000550000005500000055000000000000000000000000000000000000001
10000000000000000000000000000000000000500500005005000050050000500500005005000050050000500500000000000000000000000000000000000001
10000000000000000000000000000000000005000050050000500500005005000050050000500500005005000050000000000000000000000000000000000001
10000000000000000000000000000000000050000005500000055000000550000005500000055000000550000005000000000000000000000000000000000001
10000000000000000000000000000000000550000005500000055000000550055005500000055000000550000005500000000000000000000000000000000001
10000000000000000000000000000000005005000050050000500500005005588550050000500500005005000050050000000000000000000000000000000001
10000000000000000000000000000000050000500500005005000050050005888850005005000050050000500500005000000000000000000000000000000001
10000000000000000000000000000000500000055000000550000005500058888885000550000005500000055000000500000000000000000000000000000001
10000000000000000000000000000000500000055000000550000005500055888855000550000005500000055000000500000000000000000000000000000001
10000000000000000000000000000000050000500500005005000050050058588585005005000050050000500500005000000000000000000000000000000001
10000000000000000000000000000000005005000050050000500500005058855885050000500500005005000050050000000000000000000000000000000001
10000000000000000000000000000000000550000005500000055000000558885885500000055000000550000005500000000000000000000000000000000001
10000000000000000000000000000000000050000005500000055000000558885885500000055000000550000005000000000000000000000000000000000001
10000000000000000000000000000000000005000050050000500500005005885850050000500500005005000050000000000000000000000000000000000001
10000000000000000000000000000000000000500500005005000050050000585500005005000050050000500500000000000000000000000000000000000001
10000000000000000000000000000000000000055000000550000005500000055000000550000005500000055000000000000000000000000000000000000001
10000000000000000000000000000000000000005000000550000005500000055000000550000005500000050000000000000000000000000000000000000001
10000000000000000000000000000000000000000500005005000050050000500500005005000050050000500000000000000000000000000000000000000001
10000000000000000000000000000000000000000050050000500500005005000050050000500500005005000000000000000000000000000000000000000001
10000000000000000000000000000000000000000005500000055000000550000005500000055000000550000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000500000055000000550000005500000055000000500000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000050000500500005005000050050000500500005000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000005005000050050000500500005005000050050000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000550000005500000055000000550000005500000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000050000005500550055005500550000005000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000005000050055885500558855005000050000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000500500058888500588885000500500000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000055000588888855888888500055000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000005000558888555588885500050000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000500585885588558858500500000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000050588555888855588505000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000005588858888885588550000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000588855888855588500000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000058858588585585000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000005858855885550000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000558885885500000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000058885885000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000005885850000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000585500000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111

